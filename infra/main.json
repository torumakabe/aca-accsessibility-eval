{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "1266636316069399462"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "japaneast",
      "metadata": {
        "description": "デプロイ先のAzureリージョン"
      }
    },
    "prefix": {
      "type": "string",
      "defaultValue": "acaeval",
      "metadata": {
        "description": "リソース名のプレフィックス"
      }
    },
    "publicNetworkAccess": {
      "type": "string",
      "defaultValue": "Enabled",
      "allowedValues": [
        "Enabled",
        "Disabled"
      ],
      "metadata": {
        "description": "Container Apps環境のpublic network access設定"
      }
    }
  },
  "variables": {
    "vnetName": "[format('vnet-{0}', parameters('prefix'))]",
    "caeName": "[format('cae-{0}', parameters('prefix'))]",
    "caName": "[format('ca-{0}', parameters('prefix'))]",
    "peName": "[format('pe-{0}', parameters('prefix'))]",
    "agwName": "[format('agw-{0}', parameters('prefix'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "vnet-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[variables('vnetName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "8575321266002695459"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "VNet名"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "リージョン"
              }
            },
            "addressPrefix": {
              "type": "string",
              "defaultValue": "10.0.0.0/16",
              "metadata": {
                "description": "VNetのアドレス空間"
              }
            },
            "appGwSubnetPrefix": {
              "type": "string",
              "defaultValue": "10.0.1.0/24",
              "metadata": {
                "description": "Application Gatewayサブネットのアドレスプレフィックス"
              }
            },
            "peSubnetPrefix": {
              "type": "string",
              "defaultValue": "10.0.2.0/24",
              "metadata": {
                "description": "Private Endpointサブネットのアドレスプレフィックス"
              }
            },
            "caeSubnetPrefix": {
              "type": "string",
              "defaultValue": "10.0.16.0/23",
              "metadata": {
                "description": "Container Apps Environmentサブネットのアドレスプレフィックス"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2024-05-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "properties": {
                "addressSpace": {
                  "addressPrefixes": [
                    "[parameters('addressPrefix')]"
                  ]
                },
                "subnets": [
                  {
                    "name": "snet-appgw",
                    "properties": {
                      "addressPrefix": "[parameters('appGwSubnetPrefix')]",
                      "privateEndpointNetworkPolicies": "Enabled",
                      "privateLinkServiceNetworkPolicies": "Enabled"
                    }
                  },
                  {
                    "name": "snet-pe",
                    "properties": {
                      "addressPrefix": "[parameters('peSubnetPrefix')]",
                      "privateEndpointNetworkPolicies": "Disabled",
                      "privateLinkServiceNetworkPolicies": "Enabled"
                    }
                  },
                  {
                    "name": "snet-cae",
                    "properties": {
                      "addressPrefix": "[parameters('caeSubnetPrefix')]",
                      "privateEndpointNetworkPolicies": "Enabled",
                      "privateLinkServiceNetworkPolicies": "Enabled",
                      "delegations": [
                        {
                          "name": "Microsoft.App.environments",
                          "properties": {
                            "serviceName": "Microsoft.App/environments"
                          }
                        }
                      ]
                    }
                  }
                ]
              }
            }
          ],
          "outputs": {
            "vnetId": {
              "type": "string",
              "metadata": {
                "description": "VNetのリソースID"
              },
              "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('name'))]"
            },
            "vnetName": {
              "type": "string",
              "metadata": {
                "description": "VNetの名前"
              },
              "value": "[parameters('name')]"
            },
            "appGwSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Application Gatewayサブネットのリソースid"
              },
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('name')), '2024-05-01').subnets[0].id]"
            },
            "peSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Private EndpointサブネットのリソースID"
              },
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('name')), '2024-05-01').subnets[1].id]"
            },
            "caeSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Container Apps EnvironmentサブネットのリソースID"
              },
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('name')), '2024-05-01').subnets[2].id]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "cae-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[variables('caeName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "infrastructureSubnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'vnet-deployment'), '2025-04-01').outputs.caeSubnetId.value]"
          },
          "publicNetworkAccess": {
            "value": "[parameters('publicNetworkAccess')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "7601306864085157463"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "環境名"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "リージョン"
              }
            },
            "infrastructureSubnetId": {
              "type": "string",
              "metadata": {
                "description": "インフラストラクチャサブネットID"
              }
            },
            "publicNetworkAccess": {
              "type": "string",
              "defaultValue": "Enabled",
              "allowedValues": [
                "Enabled",
                "Disabled"
              ],
              "metadata": {
                "description": "public network access設定"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.App/managedEnvironments",
              "apiVersion": "2024-10-02-preview",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "properties": {
                "vnetConfiguration": {
                  "infrastructureSubnetId": "[parameters('infrastructureSubnetId')]",
                  "internal": false
                },
                "workloadProfiles": [
                  {
                    "name": "Consumption",
                    "workloadProfileType": "Consumption"
                  }
                ],
                "publicNetworkAccess": "[parameters('publicNetworkAccess')]",
                "zoneRedundant": false
              }
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "metadata": {
                "description": "Container Apps EnvironmentのリソースID"
              },
              "value": "[resourceId('Microsoft.App/managedEnvironments', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Container Apps Environmentの名前"
              },
              "value": "[parameters('name')]"
            },
            "defaultDomain": {
              "type": "string",
              "metadata": {
                "description": "デフォルトドメイン"
              },
              "value": "[reference(resourceId('Microsoft.App/managedEnvironments', parameters('name')), '2024-10-02-preview').defaultDomain]"
            },
            "staticIp": {
              "type": "string",
              "metadata": {
                "description": "静的IP"
              },
              "value": "[reference(resourceId('Microsoft.App/managedEnvironments', parameters('name')), '2024-10-02-preview').staticIp]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'vnet-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "ca-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[variables('caName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "environmentId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'cae-deployment'), '2025-04-01').outputs.id.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "15424289685536001091"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "アプリ名"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "リージョン"
              }
            },
            "environmentId": {
              "type": "string",
              "metadata": {
                "description": "Container Apps EnvironmentのリソースID"
              }
            },
            "containerImage": {
              "type": "string",
              "defaultValue": "mcr.microsoft.com/k8se/quickstart:latest",
              "metadata": {
                "description": "コンテナイメージ"
              }
            },
            "targetPort": {
              "type": "int",
              "defaultValue": 80,
              "metadata": {
                "description": "ターゲットポート"
              }
            },
            "externalIngress": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "外部Ingress有効化"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.App/containerApps",
              "apiVersion": "2024-03-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "properties": {
                "environmentId": "[parameters('environmentId')]",
                "workloadProfileName": "Consumption",
                "configuration": {
                  "ingress": "[if(parameters('externalIngress'), createObject('external', true(), 'targetPort', parameters('targetPort'), 'transport', 'auto', 'allowInsecure', false()), null())]"
                },
                "template": {
                  "containers": [
                    {
                      "name": "main",
                      "image": "[parameters('containerImage')]",
                      "resources": {
                        "cpu": "[json('0.25')]",
                        "memory": "0.5Gi"
                      }
                    }
                  ],
                  "scale": {
                    "minReplicas": 1,
                    "maxReplicas": 1
                  }
                }
              }
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "metadata": {
                "description": "Container AppのリソースID"
              },
              "value": "[resourceId('Microsoft.App/containerApps', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Container Appの名前"
              },
              "value": "[parameters('name')]"
            },
            "fqdn": {
              "type": "string",
              "metadata": {
                "description": "Container AppのFQDN"
              },
              "value": "[reference(resourceId('Microsoft.App/containerApps', parameters('name')), '2024-03-01').configuration.ingress.fqdn]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'cae-deployment')]"
      ]
    },
    {
      "condition": "[equals(parameters('publicNetworkAccess'), 'Disabled')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "pe-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[variables('peName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "subnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'vnet-deployment'), '2025-04-01').outputs.peSubnetId.value]"
          },
          "targetResourceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'cae-deployment'), '2025-04-01').outputs.id.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "6552692802699596073"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Private Endpoint名"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "リージョン"
              }
            },
            "subnetId": {
              "type": "string",
              "metadata": {
                "description": "Private Endpointを配置するサブネットID"
              }
            },
            "targetResourceId": {
              "type": "string",
              "metadata": {
                "description": "ターゲットリソースID（Container Apps Environment）"
              }
            },
            "groupIds": {
              "type": "array",
              "defaultValue": [
                "managedEnvironments"
              ],
              "metadata": {
                "description": "グループID"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2024-05-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('subnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[format('plsc-{0}', parameters('name'))]",
                    "properties": {
                      "privateLinkServiceId": "[parameters('targetResourceId')]",
                      "groupIds": "[parameters('groupIds')]"
                    }
                  }
                ]
              }
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "metadata": {
                "description": "Private EndpointのリソースID"
              },
              "value": "[resourceId('Microsoft.Network/privateEndpoints', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Private Endpointの名前"
              },
              "value": "[parameters('name')]"
            },
            "privateIpAddress": {
              "type": "string",
              "metadata": {
                "description": "Private EndpointのプライベートIPアドレス"
              },
              "value": "[reference(resourceId('Microsoft.Network/privateEndpoints', parameters('name')), '2024-05-01').customDnsConfigs[0].ipAddresses[0]]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'cae-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'vnet-deployment')]"
      ]
    },
    {
      "condition": "[equals(parameters('publicNetworkAccess'), 'Disabled')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "pdns-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "zoneName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'cae-deployment'), '2025-04-01').outputs.defaultDomain.value]"
          },
          "vnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'vnet-deployment'), '2025-04-01').outputs.vnetId.value]"
          },
          "vnetLinkName": {
            "value": "[format('link-{0}', variables('vnetName'))]"
          },
          "privateEndpointIp": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'pe-deployment'), '2025-04-01').outputs.privateIpAddress.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "15316170170116683335"
            }
          },
          "parameters": {
            "zoneName": {
              "type": "string",
              "metadata": {
                "description": "DNS Zone名（Container Apps Environmentのdefault domain）"
              }
            },
            "vnetId": {
              "type": "string",
              "metadata": {
                "description": "リンクするVNetのリソースID"
              }
            },
            "vnetLinkName": {
              "type": "string",
              "defaultValue": "link-vnet",
              "metadata": {
                "description": "VNetリンク名"
              }
            },
            "privateEndpointIp": {
              "type": "string",
              "metadata": {
                "description": "Private EndpointのプライベートIPアドレス"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2024-06-01",
              "name": "[parameters('zoneName')]",
              "location": "global"
            },
            {
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2024-06-01",
              "name": "[format('{0}/{1}', parameters('zoneName'), parameters('vnetLinkName'))]",
              "location": "global",
              "properties": {
                "virtualNetwork": {
                  "id": "[parameters('vnetId')]"
                },
                "registrationEnabled": false
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateDnsZones/A",
              "apiVersion": "2024-06-01",
              "name": "[format('{0}/{1}', parameters('zoneName'), '*')]",
              "properties": {
                "ttl": 3600,
                "aRecords": [
                  {
                    "ipv4Address": "[parameters('privateEndpointIp')]"
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateDnsZones/A",
              "apiVersion": "2024-06-01",
              "name": "[format('{0}/{1}', parameters('zoneName'), '@')]",
              "properties": {
                "ttl": 3600,
                "aRecords": [
                  {
                    "ipv4Address": "[parameters('privateEndpointIp')]"
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))]"
              ]
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "metadata": {
                "description": "Private DNS ZoneのリソースID"
              },
              "value": "[resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Private DNS Zoneの名前"
              },
              "value": "[parameters('zoneName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'cae-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'pe-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'vnet-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "agw-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[variables('agwName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "subnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'vnet-deployment'), '2025-04-01').outputs.appGwSubnetId.value]"
          },
          "backendFqdn": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'ca-deployment'), '2025-04-01').outputs.fqdn.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "11236532461489711362"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Application Gateway名"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "リージョン"
              }
            },
            "subnetId": {
              "type": "string",
              "metadata": {
                "description": "Application GatewayサブネットID"
              }
            },
            "backendFqdn": {
              "type": "string",
              "metadata": {
                "description": "バックエンドのFQDN（Container App）"
              }
            },
            "publicIpName": {
              "type": "string",
              "defaultValue": "[format('{0}-pip', parameters('name'))]",
              "metadata": {
                "description": "Public IP名"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/publicIPAddresses",
              "apiVersion": "2024-05-01",
              "name": "[parameters('publicIpName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Standard",
                "tier": "Regional"
              },
              "properties": {
                "publicIPAllocationMethod": "Static",
                "publicIPAddressVersion": "IPv4"
              }
            },
            {
              "type": "Microsoft.Network/applicationGateways",
              "apiVersion": "2024-05-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "properties": {
                "sku": {
                  "name": "Standard_v2",
                  "tier": "Standard_v2"
                },
                "autoscaleConfiguration": {
                  "minCapacity": 1,
                  "maxCapacity": 2
                },
                "gatewayIPConfigurations": [
                  {
                    "name": "gatewayIpConfig",
                    "properties": {
                      "subnet": {
                        "id": "[parameters('subnetId')]"
                      }
                    }
                  }
                ],
                "frontendIPConfigurations": [
                  {
                    "name": "frontendIpConfig",
                    "properties": {
                      "publicIPAddress": {
                        "id": "[resourceId('Microsoft.Network/publicIPAddresses', parameters('publicIpName'))]"
                      }
                    }
                  }
                ],
                "frontendPorts": [
                  {
                    "name": "frontendPort-http",
                    "properties": {
                      "port": 80
                    }
                  }
                ],
                "backendAddressPools": [
                  {
                    "name": "backendPool-aca",
                    "properties": {
                      "backendAddresses": [
                        {
                          "fqdn": "[parameters('backendFqdn')]"
                        }
                      ]
                    }
                  }
                ],
                "backendHttpSettingsCollection": [
                  {
                    "name": "backendHttpSettings-https",
                    "properties": {
                      "port": 443,
                      "protocol": "Https",
                      "cookieBasedAffinity": "Disabled",
                      "requestTimeout": 30,
                      "pickHostNameFromBackendAddress": true,
                      "probe": {
                        "id": "[resourceId('Microsoft.Network/applicationGateways/probes', parameters('name'), 'probe-aca')]"
                      }
                    }
                  }
                ],
                "httpListeners": [
                  {
                    "name": "listener-http",
                    "properties": {
                      "frontendIPConfiguration": {
                        "id": "[resourceId('Microsoft.Network/applicationGateways/frontendIPConfigurations', parameters('name'), 'frontendIpConfig')]"
                      },
                      "frontendPort": {
                        "id": "[resourceId('Microsoft.Network/applicationGateways/frontendPorts', parameters('name'), 'frontendPort-http')]"
                      },
                      "protocol": "Http"
                    }
                  }
                ],
                "requestRoutingRules": [
                  {
                    "name": "rule-basic",
                    "properties": {
                      "priority": 100,
                      "ruleType": "Basic",
                      "httpListener": {
                        "id": "[resourceId('Microsoft.Network/applicationGateways/httpListeners', parameters('name'), 'listener-http')]"
                      },
                      "backendAddressPool": {
                        "id": "[resourceId('Microsoft.Network/applicationGateways/backendAddressPools', parameters('name'), 'backendPool-aca')]"
                      },
                      "backendHttpSettings": {
                        "id": "[resourceId('Microsoft.Network/applicationGateways/backendHttpSettingsCollection', parameters('name'), 'backendHttpSettings-https')]"
                      }
                    }
                  }
                ],
                "probes": [
                  {
                    "name": "probe-aca",
                    "properties": {
                      "protocol": "Https",
                      "path": "/",
                      "interval": 30,
                      "timeout": 30,
                      "unhealthyThreshold": 3,
                      "pickHostNameFromBackendHttpSettings": true,
                      "minServers": 0,
                      "match": {
                        "statusCodes": [
                          "200-399"
                        ]
                      }
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', parameters('publicIpName'))]"
              ]
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "metadata": {
                "description": "Application GatewayのリソースID"
              },
              "value": "[resourceId('Microsoft.Network/applicationGateways', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Application Gatewayの名前"
              },
              "value": "[parameters('name')]"
            },
            "publicIpAddress": {
              "type": "string",
              "metadata": {
                "description": "Application GatewayのパブリックIPアドレス"
              },
              "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses', parameters('publicIpName')), '2024-05-01').ipAddress]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'ca-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'pdns-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'vnet-deployment')]"
      ]
    }
  ],
  "outputs": {
    "appGatewayPublicIp": {
      "type": "string",
      "metadata": {
        "description": "Application GatewayのパブリックIP"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'agw-deployment'), '2025-04-01').outputs.publicIpAddress.value]"
    },
    "containerAppFqdn": {
      "type": "string",
      "metadata": {
        "description": "Container AppのFQDN"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'ca-deployment'), '2025-04-01').outputs.fqdn.value]"
    },
    "privateEndpointIp": {
      "type": "string",
      "metadata": {
        "description": "Private EndpointのプライベートIP (publicNetworkAccess=Disabledの場合のみ)"
      },
      "value": "[coalesce(tryGet(tryGet(tryGet(if(equals(parameters('publicNetworkAccess'), 'Disabled'), reference(resourceId('Microsoft.Resources/deployments', 'pe-deployment'), '2025-04-01'), null()), 'outputs'), 'privateIpAddress'), 'value'), '')]"
    },
    "containerAppsEnvDefaultDomain": {
      "type": "string",
      "metadata": {
        "description": "Container Apps Environmentのデフォルトドメイン"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'cae-deployment'), '2025-04-01').outputs.defaultDomain.value]"
    },
    "vnetName": {
      "type": "string",
      "metadata": {
        "description": "VNet名"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'vnet-deployment'), '2025-04-01').outputs.vnetName.value]"
    }
  }
}